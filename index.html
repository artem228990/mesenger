<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–ü—Ä–∏–≤–∞—Ç–Ω–∏–π —á–∞—Ç</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: sans-serif;
      background: #1e1e1e;
      color: #fff;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: #333;
    }
    #menu-toggle {
      font-size: 24px;
      background: none;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    #auth-section {
      padding: 20px;
      max-width: 400px;
      margin: 50px auto;
      background: #2a2a2a;
      border-radius: 8px;
    }
    #auth-section input, #auth-section button {
      width: 100%;
      margin: 5px 0;
      padding: 10px;
      border-radius: 5px;
      border: none;
    }
    #auth-section input { background: #444; color: #fff; }
    #auth-section button { background: #009688; color: #fff; }
    .hidden { display: none !important; }
    #main-section {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    #sidebar-menu {
      width: 250px;
      background: #292929;
      padding: 10px;
      overflow-y: auto;
    }
    #sidebar-menu input, #sidebar-menu button {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 4px;
      border: none;
    }
    #sidebar-menu input { background: #444; color: #fff; }
    #sidebar-menu button { background: #009688; color: #fff; }
    .avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin-bottom: 10px;
      object-fit: cover;
    }
    #users-list div {
      padding: 8px;
      background: #3a3a3a;
      margin-bottom: 5px;
      border-radius: 4px;
      cursor: pointer;
    }
    #chat-section {
      flex: 1;
      display: none;
      flex-direction: column;
      padding: 10px;
      background: #1e1e1e;
    }
    #chat-section.visible { display: flex; }
    #messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 10px;
      background: #2a2a2a;
      padding: 10px;
      border-radius: 5px;
      word-wrap: break-word;
    }
    #messages div {
      margin-bottom: 8px;
    }
    #messages img {
      max-width: 200px;
      border-radius: 5px;
      display: block;
      margin-top: 5px;
    }
    #message-input {
      padding: 10px;
      border-radius: 4px;
      border: none;
      margin-bottom: 5px;
      background: #444;
      color: #fff;
      width: calc(100% - 110px);
    }
    #btn-send-message {
      padding: 10px;
      background: #009688;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100px;
      margin-left: 10px;
    }
    #input-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
    }
    #emoji-picker {
      max-height: 150px;
      overflow-y: auto;
      background: #333;
      padding: 5px;
      border-radius: 5px;
      margin-bottom: 5px;
      display: none;
    }
    .emoji {
      cursor: pointer;
      font-size: 24px;
      margin: 3px;
      user-select: none;
      transition: transform 0.1s ease;
      display: inline-block;
    }
    .emoji:hover {
      transform: scale(1.3);
    }
    #btn-emoji-toggle, #btn-gallery {
      font-size: 24px;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      user-select: none;
      padding: 0 5px;
    }
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å */
    @media (max-width: 768px) {
      #sidebar-menu {
        position: absolute;
        left: 0;
        top: 50px;
        bottom: 0;
        background: #292929;
        width: 250px;
        z-index: 10;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      #sidebar-menu.visible { transform: translateX(0); }
      #main-section { flex-direction: column; }
      #chat-section { flex: 1; }
      #message-input {
        width: calc(100% - 90px);
      }
      #btn-send-message {
        width: 80px;
        margin-left: 0;
      }
      #input-row {
        gap: 5px;
      }
    }
  </style>
</head>
<body>

<header id="main-header" class="hidden">
  <span>–ü—Ä–∏–≤–∞—Ç–Ω–∏–π —á–∞—Ç</span>
  <button id="menu-toggle" aria-label="–í—ñ–¥–∫—Ä–∏—Ç–∏ –º–µ–Ω—é">&#9776;</button>
</header>

<div id="auth-section">
  <h2>–í—Ö—ñ–¥ –∞–±–æ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
  <input id="email" type="email" placeholder="Email" required />
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" required />
  <button id="btn-login">–£–≤—ñ–π—Ç–∏</button>
  <button id="btn-register">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
</div>

<div id="main-section" class="hidden">
  <div id="sidebar-menu">
    <h3>–ü—Ä–æ—Ñ—ñ–ª—å</h3>
    <img id="user-avatar" src="" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar" />
    <p id="user-email"></p>
    <input id="nickname-input" type="text" placeholder="–ù—ñ–∫–Ω–µ–π–º" />
    <input id="avatar-input" type="file" accept="image/*" />
    <button id="btn-update-profile">–û–Ω–æ–≤–∏—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
    <button id="btn-logout">–í–∏–π—Ç–∏</button>
    <hr />
    <input id="search-user" type="text" placeholder="–ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤..." autocomplete="off" />
    <div id="users-list"></div>
  </div>

  <div id="chat-section">
    <h3>–ß–∞—Ç –∑ <span id="chat-with"></span></h3>
    <div id="messages"></div>

    <div id="input-row">
      <button id="btn-emoji-toggle" title="–í–∏–±—ñ—Ä —Å–º–∞–π–ª–∏–∫—ñ–≤" aria-label="–í—ñ–¥–∫—Ä–∏—Ç–∏ –ø–∞–Ω–µ–ª—å —Å–º–∞–π–ª–∏–∫—ñ–≤">üòä</button>
      <button id="btn-gallery" title="–í–∏–±—Ä–∞—Ç–∏ —Ñ–æ—Ç–æ" aria-label="–í—ñ–¥–∫—Ä–∏—Ç–∏ –≥–∞–ª–µ—Ä–µ—é">üñºÔ∏è</button>
      <input id="message-input" type="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." autocomplete="off" />
      <button id="btn-send-message">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
    </div>

    <div id="emoji-picker"></div>
    <input id="file-input" type="file" accept="image/*" style="display:none;" />
  </div>
</div>

<script type="module">
  import {
    initializeApp
  } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword,
    createUserWithEmailAndPassword, signOut, updateProfile,
    sendEmailVerification
  } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
  import {
    getFirestore, collection, doc, setDoc, getDoc,
    getDocs, query, orderBy, onSnapshot, updateDoc,
    addDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";
  import {
    getStorage, ref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBEwIyf5_e4sUL_XDIJmk8FgZ-Fmd4j43A",
    authDomain: "my-private-chat-788ac.firebaseapp.com",
    projectId: "my-private-chat-788ac",
    storageBucket: "my-private-chat-788ac.appspot.com",
    messagingSenderId: "515922784805",
    appId: "1:515922784805:web:fc228cd969560317b98aab"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const authSection = document.getElementById('auth-section');
  const mainSection = document.getElementById('main-section');
  const header = document.getElementById('main-header');

  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const btnLogin = document.getElementById('btn-login');
  const btnRegister = document.getElementById('btn-register');

  const btnLogout = document.getElementById('btn-logout');
  const userEmailDisplay = document.getElementById('user-email');
  const userAvatarImg = document.getElementById('user-avatar');
  const nicknameInput = document.getElementById('nickname-input');
  const avatarInput = document.getElementById('avatar-input');
  const btnUpdateProfile = document.getElementById('btn-update-profile');

  const searchUserInput = document.getElementById('search-user');
  const usersListDiv = document.getElementById('users-list');

  const sidebarMenu = document.getElementById('sidebar-menu');
  const menuToggleBtn = document.getElementById('menu-toggle');

  const chatSection = document.getElementById('chat-section');
  const chatWithSpan = document.getElementById('chat-with');
  const messagesDiv = document.getElementById('messages');
  const messageInput = document.getElementById('message-input');
  const btnSendMessage = document.getElementById('btn-send-message');
  const emojiPicker = document.getElementById('emoji-picker');
  const btnEmojiToggle = document.getElementById('btn-emoji-toggle');
  const btnGallery = document.getElementById('btn-gallery');
  const fileInput = document.getElementById('file-input');

  let currentUser = null;
  let currentChatUser = null;
  let unsubscribeMessages = null;



  btnLogin.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) return alert("–í–≤–µ–¥—ñ—Ç—å email —ñ –ø–∞—Ä–æ–ª—å");
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (e) {
      alert("–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: " + e.message);
    }
  };

  btnRegister.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) return alert("–í–≤–µ–¥—ñ—Ç—å email —ñ –ø–∞—Ä–æ–ª—å");
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      await sendEmailVerification(userCredential.user);
      alert("–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å –ø–æ—à—Ç—É.");
    } catch (e) {
      alert("–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó: " + e.message);
    }
  };

  btnLogout.onclick = async () => {
    await signOut(auth);
  };



  btnUpdateProfile.onclick = async () => {
    if (!currentUser) return;
    const nickname = nicknameInput.value.trim();
    try {
      let photoURL = currentUser.photoURL || null;
      if (avatarInput.files.length > 0) {
        const file = avatarInput.files[0];
        const storageRef = ref(storage, 'avatars/' + currentUser.uid);
        await uploadBytes(storageRef, file);
        photoURL = await getDownloadURL(storageRef);
      }
      await updateProfile(currentUser, {
        displayName: nickname || currentUser.displayName,
        photoURL: photoURL || currentUser.photoURL
      });
      alert("–ü—Ä–æ—Ñ—ñ–ª—å –æ–Ω–æ–≤–ª–µ–Ω–æ");
      loadUsers();
      updateUIProfile();
    } catch (e) {
      alert("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é: " + e.message);
    }
  };



  async function loadUsers() {
    const usersCol = collection(db, 'users');
    const usersSnapshot = await getDocs(usersCol);
    usersListDiv.innerHTML = '';
    usersSnapshot.forEach(docSnap => {
      const user = docSnap.data();

      if (user.uid === currentUser.uid) return;

      const userDiv = document.createElement('div');
      userDiv.textContent = user.displayName || user.email;
      if(user.photoURL) {
        const img = document.createElement('img');
        img.src = user.photoURL;
        img.alt = "–ê–≤–∞—Ç–∞—Ä";
        img.className = "avatar";
        userDiv.prepend(img);
      }
      userDiv.style.display = 'flex';
      userDiv.style.alignItems = 'center';
      userDiv.style.gap = '10px';
      userDiv.style.cursor = 'pointer';

      userDiv.onclick = () => {
        openChatWith(user);
      };
      usersListDiv.appendChild(userDiv);
    });
  }


  async function openChatWith(user) {
    currentChatUser = user;
    chatWithSpan.textContent = user.displayName || user.email;
    chatSection.classList.add('visible');
    messagesDiv.innerHTML = '';
    messageInput.value = '';
    emojiPicker.style.display = 'none';

    sidebarMenu.classList.remove('visible');

    if (unsubscribeMessages) unsubscribeMessages();

    const messagesRef = collection(db, 'messages');
    const q = query(messagesRef,
      orderBy('timestamp'));
    
    unsubscribeMessages = onSnapshot(q, (snapshot) => {
      messagesDiv.innerHTML = '';
      snapshot.forEach(docSnap => {
        const msg = docSnap.data();
  
        if (
          (msg.from === currentUser.uid && msg.to === currentChatUser.uid) ||
          (msg.from === currentChatUser.uid && msg.to === currentUser.uid)
        ) {
          const div = document.createElement('div');
          div.style.padding = '6px';
          div.style.borderRadius = '5px';
          div.style.marginBottom = '5px';
          div.style.maxWidth = '70%';

          if (msg.from === currentUser.uid) {
            div.style.background = '#009688';
            div.style.alignSelf = 'flex-end';
            div.style.color = '#fff';
          } else {
            div.style.background = '#444';
            div.style.alignSelf = 'flex-start';
            div.style.color = '#eee';
          }

          if(msg.text){
            div.textContent = msg.text;
          } else if(msg.imageUrl){
            const img = document.createElement('img');
            img.src = msg.imageUrl;
            img.alt = "–§–æ—Ç–æ";
            div.appendChild(img);
          }

          messagesDiv.appendChild(div);
        }
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  

  async function sendMessage(text, imageUrl = null) {
    if (!currentChatUser) {
      alert("–û–±–µ—Ä—ñ—Ç—å —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞");
      return;
    }
    if ((!text || text.trim() === '') && !imageUrl) {
      return; 
    }
    const messagesRef = collection(db, 'messages');
    try {
      await addDoc(messagesRef, {
        from: currentUser.uid,
        to: currentChatUser.uid,
        text: text || '',
        imageUrl: imageUrl || '',
        timestamp: serverTimestamp()
      });
      messageInput.value = '';
      emojiPicker.style.display = 'none';
    } catch (e) {
      alert("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: " + e.message);
    }
  }

  btnSendMessage.onclick = () => {
    sendMessage(messageInput.value.trim());
  };

  messageInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage(messageInput.value.trim());
    }
  });



  const emojis = [
    "üòÄ","üòÅ","üòÇ","ü§£","üòÉ","üòÑ","üòÖ","üòÜ","üòâ","üòä",
    "üòã","üòé","üòç","üòò","üòó","üòô","üòö","üôÇ","ü§ó","ü§©",
    "ü§î","ü§®","üòê","üòë","üò∂","üôÑ","üòè","üò£","üò•","üòÆ",
    "ü§ê","üòØ","üò™","üò´","üò¥","üòå","üòõ","üòú","üòù","ü§§",
    "üòí","üòì","üòî","üòï","üôÉ","ü§ë","üò≤","‚òπÔ∏è","üôÅ","üòñ",
    "üòû","üòü","üò§","üò¢","üò≠","üò¶","üòß","üò®","üò©","ü§Ø",
    "üò¨","üò∞","üò±","ü•µ","ü•∂","üò≥","ü§™","üòµ","üò°","üò†",
    "ü§¨","üò∑","ü§í","ü§ï","ü§¢","ü§Æ","ü§ß","üòá","ü§†","ü•≥",
    "ü•∫","ü§°","ü§•","ü§´","ü§≠","üßê","ü§ì"
  ];

  emojis.forEach(e => {
    const span = document.createElement('span');
    span.textContent = e;
    span.className = 'emoji';
    span.onclick = () => {
      messageInput.value += e;
      messageInput.focus();
    };
    emojiPicker.appendChild(span);
  });

  btnEmojiToggle.onclick = () => {
    if (emojiPicker.style.display === 'none') {
      emojiPicker.style.display = 'block';
    } else {
      emojiPicker.style.display = 'none';
    }
  };



  btnGallery.onclick = () => {
    fileInput.click();
  };

  fileInput.onchange = async () => {
    if (!fileInput.files.length) return;
    const file = fileInput.files[0];
    if (!file.type.startsWith('image/')) {
      alert('–í–∏–±–µ—Ä—ñ—Ç—å –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è');
      return;
    }
    try {
      const storageRef = ref(storage, 'chat_images/' + Date.now() + '_' + file.name);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);
      await sendMessage('', url);
    } catch (e) {
      alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ: ' + e.message);
    }
    fileInput.value = '';
  };



  menuToggleBtn.onclick = () => {
    sidebarMenu.classList.toggle('visible');
  };



  searchUserInput.addEventListener('input', () => {
    const filter = searchUserInput.value.toLowerCase();
    [...usersListDiv.children].forEach(div => {
      const text = div.textContent.toLowerCase();
      div.style.display = text.includes(filter) ? 'flex' : 'none';
    });
  });



  onAuthStateChanged(auth, async user => {
    currentUser = user;
    if (user) {
      authSection.classList.add('hidden');
      mainSection.classList.remove('hidden');
      header.classList.remove('hidden');
 
      updateUIProfile();
      // –î–æ–¥–∞—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —É –∫–æ–ª–µ–∫—Ü—ñ—é users
      const userDocRef = doc(db, 'users', user.uid);
      const userDoc = await getDoc(userDocRef);
      if (!userDoc.exists()) {
        await setDoc(userDocRef, {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName || user.email,
          photoURL: user.photoURL || ''
        });
      } else {
      
        await updateDoc(userDocRef, {
          displayName: user.displayName || user.email,
          photoURL: user.photoURL || ''
        });
      }
      await loadUsers();
      chatSection.classList.remove('visible');
      currentChatUser = null;
    } else {
      authSection.classList.remove('hidden');
      mainSection.classList.add('hidden');
      header.classList.add('hidden');
      if (unsubscribeMessages) unsubscribeMessages();
      currentChatUser = null;
      messagesDiv.innerHTML = '';
      usersListDiv.innerHTML = '';
    }
  });

  function updateUIProfile() {
    if (!currentUser) return;
    userEmailDisplay.textContent = currentUser.email;
    userAvatarImg.src = currentUser.photoURL || 'https://via.placeholder.com/80?text=User';
    nicknameInput.value = currentUser.displayName || '';
  }
</script>

</body>
</html>
